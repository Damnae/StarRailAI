<!doctype html>
<html lang=en>
  <head>

    <meta charset=utf-8>
    <title>StarRail AI - Enemy AI</title>
    <link rel="stylesheet" type="text/css" href="style.css">
    <script src="https://code.jquery.com/jquery-3.7.0.min.js" integrity="sha256-2Pmvv0kuTBOenSvLm6bvfBSSHrUJ+3A7x6P5Ebd07/g=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
    <script src="gamecore.js"></script>
    <script src="textMap.js"></script>
  </head>
  <body>
    
    <div id="content">
      <div class="half">
        <h1>Enemies</h1>
        <div id="enemyContainer"></div>
      </div>
      <div class="half">
        <h1>AI</h1>
        <div id="aiContainer"></div>
      </div>
    </div>

    <script>

      // TEMPLATE

      function createEnemyView(data)
      {
        var container = $(`<div id="enemy_${data.MonsterTemplateID}" class="character">`);

        var title = $(`<h2 class="section-opener">`).html(`${translate(data.MonsterName?.Hash)} <span class="code">(${data.MonsterTemplateID})</span>`);
        var content = $(`<div class="section-content">`);

        container.append(title);
        container.append(content);
        
        var decisionsId = data.AIPath.replace('Config/ConfigAI/', '');
        content.append($(`<a href="#${decisionsId}">`).html(`AI Decisions <span class="code">(${cleanupDecisionsName(decisionsId)})</span>`));
        content.append(createExplanationView(data, function(c)
        {
          c.append($('<div>').text('Template'));
          return true;
        }));

        var characterConfig = data.JsonConfig;
        var abilityConfig = data.JsonConfig.replace('ConfigCharacter', 'ConfigAbility').replace('_Config', '_Ability');

        title.click(function() {
          content.slideToggle();

          if (!content.data('opened')) 
          {
            $.ajax({
              url: 'https://raw.githubusercontent.com/Dimbreath/StarRailData/master/' + characterConfig,
              type: 'GET',
              dataType: 'json',
              cache: true,
              success: function(characterData)
              {
                content.append(createExplanationView(characterData, function(c)
                {
                  c.append($('<div>').text('Character'));
                  return true;
                }));

                $.ajax({
                  url: 'https://raw.githubusercontent.com/Dimbreath/StarRailData/master/' + abilityConfig,
                  type: 'GET',
                  dataType: 'json',
                  cache: true,
                  success: function(abilityData)
                  {
                    content.append(createEnemyDetailView(characterData, abilityData));
                  },
                  error: function(xhr, status, error) 
                  {
                    console.error('Ability Config Error:', error);
                    content.append(createEnemyDetailView(characterData, undefined));
                  },
                });
              },
              error: function(xhr, status, error) 
              {
                console.error('Character Config Error:', error);
              },
            });
            content.data('opened', true);
          }
        });

        return container;
      }

      function createEnemyDetailView(characterData, abilityData)
      {
        var container = $(`<div class="characterDetail">`);

        var customValues = characterData.CustomValues;
        if (customValues != undefined)
        {
          container.append($('<h3>').text('Variables'));
          var variablesContainer = $('<div>');
          for (var key in customValues) 
            if (customValues.hasOwnProperty(key)) 
            {
              var customValue = customValues[key];
              variablesContainer.append($('<div>').html(`<span class="code">${key}</span> = <span class="code">${customValue}</span>`));
            }
          container.append(variablesContainer);
        }

        var globalModifiers = abilityData?.GlobalModifiers;
        if (globalModifiers != undefined)
        {
          container.append($('<h3>').text('Global modifiers'));
          container.append(createModifiersView(globalModifiers));
        }

        var skills = characterData.SkillList;
        container.append($('<h3>').text('Skills'));
        for (var i = 0; i < skills.length; i++)
        {
          var skill = skills[i];
          container.append($('<h4>').html(`${skill.Name} <span class="code">${skill.SkillType} / ${skill.UseType} / ${skill.TargetInfo?.TargetType}</span>`));
          
          if (abilityData != undefined)
          {
            var abilityNames = findSkillAbilities(skill.Name, characterData);
            if (abilityNames != undefined)
            {
              for (var j = 0; j < abilityNames.length; j++)
              {
                var abilityName = abilityNames[j];
                var ability = findAbility(abilityName, abilityData);
                if (ability != undefined)
                  container.append(createAbilityView(ability));
                else container.append($('<h5>').html(`<span class="code">${abilityName}</span> (missing)`));
              }
            }
            else
            {
              var ability = findAbility(skill.EntryAbility, abilityData);
              if (ability != undefined)
                container.append(createAbilityView(ability));
              else container.append($('<h5>').html(`<span class="code">${skill.EntryAbility}</span> (missing)`));
            }
          }
        }

        //container.append($('<pre>').text(JSON.stringify(characterData, null, 2)));
        //container.append($('<pre>').text(JSON.stringify(abilityData, null, 2)));
        return container;
      }

      function createAbilityView(data)
      {
        var container = $(`<div class="ability">`);
        container.append($('<h5>').html(`<span class="code">${data.Name}</span>`));

        var onStart = data.OnStart;
        var modifiers = data.Modifiers;

        if (onStart != undefined)
        {
          container.append($('<div>').html(`On Start:`));
          for (var i = 0; i < onStart.length; i++)
          {
            var onStartAction = onStart[i];
            container.append(createGamecoreView(onStartAction));
          }
        }

        if (modifiers != undefined)
        {
          container.append($('<div>').html(`Modifiers:`));
          container.append(createModifiersView(modifiers));
        }

        //container.append($('<pre>').text(JSON.stringify(data, null, 2)));
        return container;
      }

      function createModifiersView(data)
      {
        var container = $(`<div class="modifiers">`);
        for (var modifierName in data) 
          if (data.hasOwnProperty(modifierName)) 
          {
            var modifier = data[modifierName];
            container.append(createExplanationView(modifier, function(modifierContainer)
            {
              modifierContainer.append($('<div>').html(`${modifierName}:`));

              var events = modifier._CallbackList;
              if (events != undefined)
              {
                for (var eventName in events) 
                  if (events.hasOwnProperty(eventName)) 
                  {
                    var event = events[eventName];
                    modifierContainer.append(createExplanationView(event, function(eventContainer)
                    {
                      eventContainer.append($('<div>').html(`${eventName}:`));

                      var config = event.CallbackConfig;
                      if (config != undefined)
                      {
                        for (var i = 0; i < config.length; i++)
                        {
                          var action = config[i];
                          eventContainer.append(createGamecoreView(action));
                        }
                        return true;
                      } else return false;
                    }));
                  }
                return true;
              } else return false;
            }));
          }
        return container;
      }

      // AI

      function createAIView(characterFileData)
      {
        var container = $(`<div id="${characterFileData.path}" class="character">`);

        var title = $(`<h2 class="section-opener">`).text(cleanupDecisionsName(characterFileData.path));
        var content = $(`<div class="section-content">`);

        container.append(title);
        container.append(content);

        title.click(function() {
          content.slideToggle();

          if (!content.data('opened')) 
          {
            $.ajax({
              url: 'https://raw.githubusercontent.com/Dimbreath/StarRailData/master/Config/ConfigAI/' + characterFileData.path,
              type: 'GET',
              dataType: 'json',
              cache: true,
              success: function(data)
              {
                content.append(createAIDetailView(data));
              },
              error: function(xhr, status, error) 
              {
                console.error('Error:', error);
              },
            });
            content.data('opened', true);
          }
        });

        return container;
      }

      function createAIDetailView(data)
      {
        var container = $(`<div class="characterDetail">`);
        
        var variables = data.VariableList;
        var decisions = data.DecisionList;
        
        var variableContainer = $(`<pre class="characterSkill">`);
        for (var i = 0; i < variables.length; i++) 
        {
          var variable = variables[i];
          
          var type = variable.$type.replace('RPG.GameCore.AIVariable', '');
          var value = variable.Value;
          var name = variable.Name;

          variableContainer.append($('<div>').text(`${type} ${name} = ${value};`));
        }
        container.append(variableContainer);

        for (var i = 0; i < decisions.length; i++) 
        {
          var decision = decisions[i];
          container.append(createDecisionView(decision));

          //container.append($('<pre>').text(JSON.stringify(decision, null, 2)));
        }
        return container;
      }

      function createDecisionView(data)
      {
        var container = $(`<div class="characterSkill">`);
        container.append(createGamecoreView(data));
        return container;
      }

      // UTIL

      function findSkillAbilities(name, data)
      {
        for (var i = 0; i < data.SkillAbilityList.length; i++)
        {
          var skill = data.SkillAbilityList[i];
          if (skill.Skill == name)
            return skill.AbilityList;
        }
        return undefined;
      }

      function findAbility(name, abilityData)
      {
        for (var i = 0; i < abilityData.AbilityList.length; i++)
        {
          var ability = abilityData.AbilityList[i];
          if (ability.Name == name)
            return ability;
        }

        for (var i = 0; i < commonAbilities.AbilityList.length; i++)
        {
          var ability = commonAbilities.AbilityList[i];
          if (ability.Name == name)
            return ability;
        }

        for (var i = 0; i < commonAdditionalAbilities.AbilityList.length; i++)
        {
          var ability = commonAdditionalAbilities.AbilityList[i];
          if (ability.Name == name)
            return ability;
        }
        
        if (name != undefined && !name.includes('Camera'))
          console.log('Ability not found ' + name);

        return undefined;
      }

      function cleanupDecisionsName(path)
      {
        return path.replace(/_/g, " ").replace('.json', '');
      }

      // INITIALISATION

      var commonAbilities = {
        AbilityList: [],
      };

      var commonAdditionalAbilities = {
        AbilityList: [],
      };

      function initialize()
      {
        $.ajax({
          url: 'https://raw.githubusercontent.com/Dimbreath/StarRailData/master/Config/ConfigAbility/Monster/Monster_Common_Ability.json',
          type: 'GET',
          dataType: 'json',
          cache: true,
          success: function(data)
          {
            commonAbilities = data;
          },
          error: function(xhr, status, error) 
          {
            console.error('Monster Common Ability Error:', error);
          },
        }).then(function() 
        {
          if (false)
          $.ajax({
            url: 'https://raw.githubusercontent.com/Dimbreath/StarRailData/master/Config/ConfigAbility/Common_Additional_Ability.json',
            type: 'GET',
            dataType: 'json',
            cache: true,
            success: function(data)
            {
              commonAdditionalAbilities = data;
            },
            error: function(xhr, status, error) 
            {
              console.error('Common Additional Ability Error:', error);
            },
          });
        }).then(function() 
        {
          $.ajax({
            url: 'https://raw.githubusercontent.com/Dimbreath/StarRailData/master/ExcelOutput/MonsterTemplateConfig.json',
            type: 'GET',
            dataType: 'json',
            cache: true,
            success: function(data)
            {
              var container = $('#enemyContainer');  
              for (var key in data) 
                if (data.hasOwnProperty(key)) 
                {
                  var enemy = data[key];
                  container.append(createEnemyView(enemy));
                }
            },
            error: function(xhr, status, error) 
            {
              console.error('Monster Template Error:', error);
            },
          });
        });

        $.ajax({
          url: 'https://api.github.com/repos/Dimbreath/StarRailData/git/trees/master:Config/ConfigAI',
          type: 'GET',
          dataType: 'json',
          cache: true,
          success: function(data)
          {
            var tree = data.tree;

            var container = $('#aiContainer');          
            for (var i = 0; i < tree.length; i++) 
            {
              var file = tree[i];

              if (file.type == 'blob')
                container.append(createAIView(file));
            }
          },
          error: function(xhr, status, error) 
          {
            console.error('AI Config Error:', error);
          },
        });
      }

      $(function() { 
        initializeTranslation(initialize); 
      });

    </script>
  </body>
</html>
